- id: home_empty_tracker
  alias: Отслеживание когда все ушли из дома
  triggers:
    - trigger: state
      entity_id: person.andrey_sitnik
      from: near_home
      to: not_home
    - trigger: state
      entity_id: person.ekaterina_sitnik
      from: near_home
      to: not_home
    - trigger: state
      entity_id: device_tracker.ip_atocha
    - trigger: state
      entity_id: device_tracker.ip_pixel_7a
    - trigger: state
      entity_id: input_boolean.guests
    - trigger: state
      entity_id: input_boolean.other_people
  conditions:
    - condition: state
      entity_id: device_tracker.ucg_max
      state: "home"
    - condition: state
      entity_id: sensor.u7_pro_xgs_state
      state: "connected"
  actions:
    - if:
        - or:
            - condition: state
              entity_id: device_tracker.ip_atocha
              state: "home"
            - condition: state
              entity_id: device_tracker.ip_pixel_7a
              state: "home"
            - condition: state
              entity_id: input_boolean.other_people
              state: "on"
            - condition: state
              entity_id: input_boolean.guests
              state: "on"
      then:
        - action: input_boolean.turn_off
          target:
            entity_id: input_boolean.home_empty
      else:
        - action: input_boolean.turn_on
          target:
            entity_id: input_boolean.home_empty

- id: turn_off_on_leaving
  alias: Выключить всё, когда все ушли
  triggers:
    - trigger: state
      entity_id: input_boolean.home_empty
      to: "on"
    - trigger: state
      entity_id: person.andrey_sitnik
      from: "near_home"
      to: "not_home"
    - trigger: state
      entity_id: person.ekaterina_sitnik
      from: "near_home"
      to: "not_home"
  conditions:
    - condition: state
      entity_id: input_boolean.home_empty
      state: "on"
    - condition: state
      entity_id: input_boolean.stop
      state: "off"
  actions:
    - action: script.turn_off_everything
    - action: water_heater.set_operation_mode
      target:
        entity_id: water_heater.home_domestic_hot_water_0
      data:
        operation_mode: "OFF"
    - if:
        - condition: state
          entity_id: input_boolean.heating
          state: "on"
      then:
        - action: switch.turn_on
          target:
            entity_id: switch.heater_micraplus_25_main_away_mode
    - if:
        - condition: state
          entity_id: input_boolean.cooling
          state: "on"
      then:
        - action: climate.turn_off
          target:
            entity_id:
              - climate.ac_hall
              - climate.ac_bedroom
    - if:
        - or:
            - condition: state
              entity_id: input_boolean.heating
              state: "on"
            - condition: state
              entity_id: input_boolean.cooling
              state: "on"
      then:
        - action: cover.close_cover
          target:
            entity_id: cover.blind_ikea_lounge

- id: mark_vacuum_started_today
  alias: Отметить, что пылесос был запущен сегодня
  triggers:
    - trigger: state
      entity_id: vacuum.vacuum_roborock_q7_max
      from: "docked"
      to: "cleaning"
  actions:
    - action: input_boolean.turn_on
      data:
        entity_id: input_boolean.vacuum_was_run_today

- id: reset_vacuum_started_today
  alias: Сбросить отметку о запуске пылесоса сегодня
  triggers:
    - trigger: time
      at: "04:00:00"
  actions:
    - action: input_boolean.turn_off
      data:
        entity_id: input_boolean.vacuum_was_run_today

- id: daily_vacuum_on_leaving
  alias: Ежедневная уборка пылесосом когда все ушли
  triggers:
    - trigger: state
      entity_id: input_boolean.home_empty
      to: "on"
  conditions:
    - condition: state
      entity_id: input_boolean.vacuum_was_run_today
      state: "off"
    - condition: state
      entity_id: input_boolean.stop
      state: "off"
    - condition: state
      entity_id: input_boolean.cat_alone
      state: "off"
    - condition: state
      entity_id: input_boolean.other_people
      state: "off"
    - condition: time
      after: "08:40:00"
      before: "22:00:00"
  actions:
    - action: vacuum.start
      target:
        entity_id: vacuum.vacuum_roborock_q7_max
